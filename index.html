<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Выставление часов по проекту</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root { --card:#ffffff; --muted:#dfe6e9; }
  body { font-family:'Segoe UI', sans-serif; background:var(--tg-theme-bg-color, #f5f6fa); color:var(--tg-theme-text-color, #2f3640); margin:0; }
  header{ padding:12px 16px; text-align:center; font-weight:600; font-size:18px; }
  .card{ display:flex; flex-direction:column; align-items:center; gap:12px; background:var(--card,#fff); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.06); padding:12px; max-width:420px; margin:0 auto; }
  .summary-title{ font-size:13px; text-transform:uppercase; letter-spacing:.04em; color:#636e72; margin-bottom:6px; }
  .summary-total{ font-size:16px; font-weight:700; margin-bottom:8px; }
  .summary-list{ width:100%; display:flex; flex-direction:column; gap:6px; max-height:150px; overflow-y:auto; }
  .row{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border:1px solid var(--muted); border-radius:8px; background:#fff; cursor:pointer; }
  .row.active{ border-color:#0984e3; background:rgba(9,132,227,0.08); }
  .row .left{ display:flex; align-items:center; gap:8px; }
  .dot{ width:10px; height:10px; border-radius:50%; }
  .name{ font-size:13px; font-weight:600; }
  .hrs{ font-variant-numeric:tabular-nums; font-weight:700; }

  .circle-container{ position:relative; width:100%; max-width:280px; aspect-ratio:1/1; margin:6px auto 0; }
  canvas{ touch-action:none; width:100%; height:100%; }
  .hours{ font-size:20px; margin:8px 0 0; font-weight:bold; text-align:center; }
  .center-button{ position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:64px; height:64px; background:#0984e3; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 28px rgba(9,132,227,.35); cursor:pointer; transition:transform .08s ease, background .2s ease; }
  .center-button:active{ transform:translate(-50%, -50%) scale(.98); }
  .center-button svg{ width:28px; height:28px; stroke:#fff; }
</style>
</head>
<body>
<header>Выставление часов</header>
<div class="card">
  <div class="summary-title">Итоги по проектам</div>
  <div id="summaryTotal" class="summary-total">Всего: 0 / 8 ч</div>
  <div id="summaryList" class="summary-list"></div>
  <div class="circle-container">
    <canvas id="circle"></canvas>
    <div class="center-button" id="submitButton" title="Внести часы">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14M5 12h14" />
      </svg>
    </div>
  </div>
  <div class="hours" id="hoursDisplay">0 ч</div>
</div>
<script>
  const tg = window.Telegram?.WebApp; tg?.expand();
  const BASE_STROKE = 26;
  const SEGMENT_STROKE = 30;
  const maxHours = 8;

  const projects = [
    { id: 1, name: 'Проект А', color: 'dodgerblue' },
    { id: 2, name: 'Проект B', color: 'tomato' },
    { id: 3, name: 'Проект C', color: 'mediumseagreen' },
    { id: 4, name: 'Проект D', color: 'gold' },
    { id: 5, name: 'Проект E', color: 'purple' },
    { id: 6, name: 'Проект F', color: 'orange' },
    { id: 7, name: 'Проект G', color: 'teal' }
  ];
  const hoursPerProject = Object.fromEntries(projects.map(p => [p.id, 0]));
  let activeId = projects[0].id;

  const summaryList = document.getElementById('summaryList');
  const summaryTotal = document.getElementById('summaryTotal');
  const hoursDisplay = document.getElementById('hoursDisplay');
  const canvas = document.getElementById('circle');
  const ctx = canvas.getContext('2d');
  let centerX, centerY, radius;

  function resizeCanvas(){
    canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
    const maxStroke = Math.max(BASE_STROKE, SEGMENT_STROKE);
    centerX = canvas.width/2; centerY = canvas.height/2; radius = Math.max(10, canvas.width/2 - (maxStroke/2) - 6);
    drawCircle();
  }
  window.addEventListener('resize', resizeCanvas);

  function sumHours(){ return Object.values(hoursPerProject).reduce((a,b)=>a+(b|0),0); }
  function sumHoursExcept(id){ return Object.entries(hoursPerProject).reduce((a,[k,v])=>a + (parseInt(k)===id?0:(v|0)), 0); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function renderSummary(){
    summaryList.innerHTML = '';
    projects.forEach(p => {
      const row = document.createElement('div'); row.className = 'row' + (p.id===activeId?' active':'');
      const left = document.createElement('div'); left.className='left';
      const dot = document.createElement('span'); dot.className='dot'; dot.style.background=p.color;
      const name = document.createElement('span'); name.className='name'; name.textContent=p.name;
      left.append(dot,name);
      const hrs = document.createElement('div'); hrs.className='hrs'; hrs.textContent = (hoursPerProject[p.id]|0) + ' ч';
      row.append(left, hrs);
      row.addEventListener('click', () => { activeId = p.id; updateDisplay(); drawCircle(); renderSummary(); });
      summaryList.append(row);
    });
    summaryTotal.textContent = `Всего: ${sumHours()} / ${maxHours} ч`;
  }

  function drawCircle(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.beginPath(); ctx.arc(centerX, centerY, radius, 0, Math.PI*2); ctx.strokeStyle='#dfe6e9'; ctx.lineWidth=BASE_STROKE; ctx.lineCap='round'; ctx.stroke();
    const ordered = [...projects].sort((a,b)=>a.id-b.id);
    let start = -Math.PI/2;
    ordered.forEach(p => {
      const hrs = hoursPerProject[p.id] | 0; if(!hrs) return;
      const ang = (hrs/maxHours) * 2*Math.PI;
      ctx.beginPath(); ctx.arc(centerX, centerY, radius, start, start+ang);
      ctx.strokeStyle = p.color; ctx.lineWidth = SEGMENT_STROKE; ctx.lineCap='round'; ctx.stroke();
      start += ang;
    });
  }

  function updateDisplay(){ hoursDisplay.textContent = (hoursPerProject[activeId]|0) + ' ч'; renderSummary(); }

  let startDragAngle=0, hoursAccumulator=0, dragging=false;
  function getAngleFromEvent(e){ const r=canvas.getBoundingClientRect(); const cx=(e.touches?e.touches[0].clientX:e.clientX)-r.left-centerX; const cy=(e.touches?e.touches[0].clientY:e.clientY)-r.top-centerY; return Math.atan2(cy,cx); }
  function onStart(e){ e.preventDefault(); dragging=true; hoursAccumulator=0; startDragAngle=getAngleFromEvent(e); }
  function onMove(e){
    if(!dragging) return; e.preventDefault();
    const cur=getAngleFromEvent(e); let d=cur-startDragAngle; if(d<-Math.PI) d+=2*Math.PI; if(d>Math.PI) d-=2*Math.PI; startDragAngle=cur;
    const deltaHours=(d/(2*Math.PI))*maxHours; hoursAccumulator+=deltaHours;
    const step = (hoursAccumulator>0)?Math.floor(hoursAccumulator):Math.ceil(hoursAccumulator);
    if(step!==0){
      const capacityLeft = maxHours - sumHoursExcept(activeId);
      const current = hoursPerProject[activeId] | 0;
      const newVal = clamp(current + step, 0, Math.min(maxHours, current + capacityLeft));
      const applied = newVal - current;
      if(applied!==0){ hoursPerProject[activeId] = newVal; hoursAccumulator -= applied; drawCircle(); updateDisplay(); }
      else { hoursAccumulator = 0; }
    }
  }
  function onEnd(){ dragging=false; hoursAccumulator=0; }

  function init(){ renderSummary(); resizeCanvas(); updateDisplay(); }

  canvas.addEventListener('mousedown', onStart);
  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup', onEnd);
  canvas.addEventListener('touchstart', onStart, {passive:false});
  window.addEventListener('touchmove', onMove, {passive:false});
  window.addEventListener('touchend', onEnd);

  document.getElementById('submitButton').addEventListener('click', () => {
    const payload = { activeId, hoursPerProject, total: sumHours(), capacity: maxHours };
    if(tg){ tg.sendData(JSON.stringify(payload)); }
  });

  init();
</script>
</body>
</html>
